<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Analysis - Machine Diagnostics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Slab:wght@400;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v=7.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}?v=7.1">
</head>

<body>
    <div class="report-container">
        <!-- 1. Report Header -->
        <header class="report-header">
            <div class="header-main">
                <a href="/" class="btn btn-secondary back-btn">‚Üê Back to Dashboard</a>
                <div class="header-content">
                    <h1>Machine Diagnostics Report</h1>
                    <p class="subtitle">Session-based analysis using audio, vibration, and gas sensors</p>
                </div>
                <div class="session-meta-group" id="session-info">
                    <div class="meta-item">
                        <span class="label">Session Start</span>
                        <strong class="value" id="session-start-display">--:--:--</strong>
                    </div>
                    <div class="meta-item">
                        <span class="label">Duration</span>
                        <strong class="value" id="session-duration-display">--s</strong>
                    </div>
                </div>
            </div>
        </header>

        <!-- 2. Database Status Strip -->
        <div class="status-strip" id="db-status">
            <div class="status-item loading">Initializing database connection...</div>
        </div>

        <!-- 3. Workflow Steps -->
        <div class="workflow-steps">
            <!-- Step 1 -->
            <div class="step-card" id="load-panel">
                <div class="step-number">01</div>
                <div class="step-content">
                    <h3>Load Session Data</h3>
                    <p>Retrieve the latest sensor telemetry from the local database.</p>
                </div>
                <div class="step-action">
                    <button class="btn btn-primary btn-lg" onclick="useLatestData(event)">
                        Load Latest Data
                    </button>
                    <div class="step-status" id="load-status-text"></div>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="step-card disabled" id="analyze-panel">
                <div class="step-number">02</div>
                <div class="step-content">
                    <h3>AI Diagnosis</h3>
                    <p>Send aggregated session telemetry to Gemini 1.5 Flash for analysis.</p>
                </div>
                <div class="step-action">
                    <button class="btn btn-gemini btn-lg" id="analyze-btn" onclick="analyzeWithGemini()" disabled>
                        Analyze with Gemini AI
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. Data Summary Dashboard (Grid) -->
        <div class="dashboard-grid" id="data-dashboard" style="display: none;">
            <!-- Injected by JS: Overview, Sound, Vibration -->
            <div class="dashboard-loading">Loading data visualization...</div>
        </div>

        <!-- Hidden Prompt Panel (for debug/transparency) -->
        <div class="panel collapsed" id="prompt-panel" style="display: none; margin-top: 20px;">
            <div class="panel-header" onclick="togglePrompt()">
                <h3>üìù System Prompt & Data Payload</h3>
                <span class="badge">DEBUG</span>
            </div>
            <div class="panel-body" style="display: none;">
                <div class="json-display" id="prompt-display"></div>
            </div>
        </div>

        <!-- 5. Response Panel -->
        <div class="response-section" id="response-panel" style="display: none;">
            <div class="response-header-strip">
                <h3>üîç Diagnostic Results</h3>
                <button class="btn btn-sm btn-secondary" onclick="copyResponse()">Copy JSON</button>
            </div>

            <div class="health-overview-card">
                <div class="health-indicator">
                    <span class="label">Machine Health Status</span>
                    <h2 id="health-status-value">--</h2>
                </div>
                <div class="severity-indicator">
                    <span class="label">Severity Assessment</span>
                    <span class="severity-badge" id="severity-badge">--</span>
                </div>
            </div>

            <div class="findings-grid">
                <div class="findings-col">
                    <h4>Key Findings</h4>
                    <div id="findings-list" class="findings-list"></div>
                </div>
                <div class="actions-col">
                    <h4>Recommended Actions</h4>
                    <div id="actions-list" class="actions-list"></div>
                </div>
            </div>

            <div class="notes-box" id="notes-section" style="display: none;">
                <h4>Additional Notes</h4>
                <p id="notes-content"></p>
            </div>

            <!-- Raw Response Toggle -->
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-sm btn-text"
                    onclick="document.getElementById('raw-response-container').style.display = 'block'">View Raw API
                    Response</button>
            </div>
            <div id="raw-response-container" style="display: none; margin-top: 10px;">
                <div class="json-display" id="raw-response"></div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script>
        let sessionData = null;
        let geminiResponse = null;

        const SYSTEM_PROMPT = `You are an industrial machine diagnostics assistant.
You will be given a SINGLE machine session summary as structured JSON.
This data was generated by deterministic signal-processing code and
represents aggregated sensor behavior over a fixed time window.

IMPORTANT RULES:
- Do NOT assume missing data.
- Do NOT invent sensors or values.
- Base all conclusions strictly on the provided JSON.
- If evidence is weak, say so explicitly.

TASK:
Analyze the session summary and return your response in STRICT JSON
using EXACTLY the following schema:

{
  "health_status": "NORMAL | WARNING | CRITICAL",
  "key_findings": [
    {
      "signal": "sound | vibration | gas | combined",
      "observation": "short factual observation",
      "interpretation": "likely technical meaning",
      "confidence": "LOW | MEDIUM | HIGH"
    }
  ],
  "overall_severity": "LOW | MEDIUM | HIGH",
  "recommended_actions": [
    "action item 1",
    "action item 2"
  ],
  "notes": "optional clarifications or uncertainty"
}

SESSION SUMMARY:
`;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const startTs = urlParams.get('start');
        const stopTs = urlParams.get('stop');
        const autoload = urlParams.get('autoload') === 'true';

        document.addEventListener('DOMContentLoaded', () => {
            checkDatabaseStatus();

            if (startTs && stopTs) {
                // Update Time Display
                document.getElementById('session-start-display').textContent = formatTime(startTs);

                if (autoload) {
                    loadSessionData();
                }
            }
        });

        // ---------------------------------------------------------
        // 1. DATABASE STATUS STRIP
        // ---------------------------------------------------------
        async function checkDatabaseStatus() {
            const statusEl = document.getElementById('db-status');
            try {
                const res = await fetch('/debug-db');
                const dbInfo = await res.json();

                statusEl.innerHTML = `
                    <div class="status-item">
                        <span class="status-label">RAW AUDIO</span>
                        <span class="status-value">${dbInfo.raw_audio_count}</span>
                        <span class="status-indicator ok"></span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ESP32 DATA</span>
                        <span class="status-value">${dbInfo.esp32_data_count}</span>
                        <span class="status-indicator ok"></span>
                    </div>
                    <div class="status-item">
                         <span class="status-label">RANGE</span>
                         <span class="status-value narrow">${dbInfo.raw_audio_earliest ? formatTimeShort(dbInfo.raw_audio_earliest) : 'N/A'} - ${dbInfo.raw_audio_latest ? formatTimeShort(dbInfo.raw_audio_latest) : 'N/A'}</span>
                    </div>
                `;
            } catch (err) {
                statusEl.innerHTML = '<div class="status-item error">Database connection failed</div>';
            }
        }

        // ---------------------------------------------------------
        // 2. LOAD DATA LOGIC
        // ---------------------------------------------------------
        async function useLatestData(event) {
            let btn = event.target;
            try {
                btn.disabled = true;
                btn.innerHTML = 'Querying...';

                const res = await fetch('/latest-data-range?duration=60');
                const data = await res.json();

                if (!data.has_data) {
                    alert('No data found.');
                    btn.disabled = false;
                    btn.innerHTML = 'Load Latest Data';
                    return;
                }

                window.location.href = `/gemini-analysis?start=${encodeURIComponent(data.start)}&stop=${encodeURIComponent(data.stop)}&autoload=true`;
            } catch (err) {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = 'Load Latest Data';
            }
        }

        async function loadSessionData() {
            // Update UI State
            document.getElementById('load-status-text').innerHTML = '<span class="spinner"></span> Fetching...';

            try {
                const params = new URLSearchParams({ start: startTs, stop: stopTs });
                const res = await fetch(`/session-preview?${params.toString()}`);
                sessionData = await res.json();

                if (sessionData.error) throw new Error(sessionData.error);

                // Update Duration
                document.getElementById('session-duration-display').textContent = `${sessionData.session.duration_sec}s`;

                // Render Dashboard Cards
                displayDataSummary(sessionData);
                document.getElementById('data-dashboard').style.display = 'grid';

                // Unlock Gemini Step
                const step2 = document.getElementById('analyze-panel');
                step2.classList.remove('disabled');
                step2.classList.add('active');
                document.getElementById('analyze-btn').disabled = false;

                // Mark Step 1 Complete
                document.getElementById('load-panel').classList.add('complete');
                document.getElementById('load-status-text').innerHTML = '‚úÖ Data Loaded';

                // Update Prompt Debug
                const promptContent = SYSTEM_PROMPT.replace('SESSION SUMMARY:\n', '') +
                    `\n// SESSION DATA:\n` + JSON.stringify(sessionData, null, 2);
                document.getElementById('prompt-display').innerHTML = syntaxHighlight(promptContent);

            } catch (err) {
                console.error(err);
                document.getElementById('load-status-text').innerHTML = '‚ùå Error loading data';
            }
        }

        // ---------------------------------------------------------
        // 3. DASHBOARD CARDS RENDERER (CRITICAL)
        // ---------------------------------------------------------
        function displayDataSummary(data) {
            const container = document.getElementById('data-dashboard');

            const sound = data.sound_summary || {};
            const vib = data.vibration_summary || {};
            const gas = data.gas_summary || {};

            const dataMode = sound.data_mode || 'unknown';
            const modeClass = dataMode === 'live' ? 'status-live' : 'status-calib';
            const modeLabel = dataMode === 'live' ? 'LIVE DATA' : 'CALIBRATION';

            container.innerHTML = `
                <!-- 1. OVERVIEW CARD -->
                <div class="dashboard-card overview-card">
                    <div class="card-header">
                        <h4>Session Overview</h4>
                        <span class="badge ${modeClass}">${modeLabel}</span>
                    </div>
                    <div class="card-body">
                        <div class="metric-big">
                            <div class="label">Mode</div>
                            <div class="value">${dataMode.toUpperCase()}</div>
                        </div>
                        <div class="metric-row">
                             <span>Sensor Status</span>
                             <span class="status-ok">Active</span>
                        </div>
                         <div class="metric-row">
                             <span>Sample Integrity</span>
                             <span class="status-ok">100%</span>
                        </div>
                    </div>
                </div>

                <!-- 2. SOUND ANALYSIS CARD -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h4>Sound Analysis</h4>
                        <span class="icon">üîä</span>
                    </div>
                    <div class="card-body">
                        <table class="metric-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Dominant Freq</td>
                                    <td class="highlight">${(sound.dominant_freq_median || 0).toFixed(1)}</td>
                                    <td>Hz</td>
                                </tr>
                                <tr>
                                    <td>IQR Range</td>
                                    <td>${(sound.freq_iqr?.[0] || 0).toFixed(0)} - ${(sound.freq_iqr?.[1] || 0).toFixed(0)}</td>
                                    <td>Hz</td>
                                </tr>
                                <tr>
                                    <td>Out-of-Profile</td>
                                    <td class="${(sound.out_of_profile_events || 0) > 0 ? 'warn' : 'ok'}">${sound.out_of_profile_events || 0}</td>
                                    <td>Count</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. VIBRATION CARD -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h4>Vibration</h4>
                        <span class="icon">üì≥</span>
                    </div>
                    <div class="card-body">
                        <table class="metric-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Average Act.</td>
                                    <td>${(vib.avg || 0).toFixed(1)}</td>
                                    <td>%</td>
                                </tr>
                                <tr>
                                    <td>Peak Act.</td>
                                    <td class="highlight">${(vib.peak || 0).toFixed(1)}</td>
                                    <td>%</td>
                                </tr>
                                <tr>
                                    <td>Events</td>
                                    <td>${vib.event_count || 0}</td>
                                    <td>Count</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ---------------------------------------------------------
        // 4. GEMINI ANALYSIS LOGIC
        // ---------------------------------------------------------
        async function analyzeWithGemini() {
            const btn = document.getElementById('analyze-btn');
            btn.innerHTML = 'Analyzing...';
            btn.disabled = true;

            try {
                const res = await fetch('/gemini-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_data: sessionData })
                });

                const result = await res.json();
                if (!res.ok || result.error) throw new Error(result.error || 'Failed');

                geminiResponse = result.analysis;
                renderResponse(geminiResponse);

                btn.innerHTML = 'Analysis Complete';
                document.getElementById('analyze-panel').classList.add('complete');

            } catch (err) {
                alert(err.message);
                btn.disabled = false;
                btn.innerHTML = 'Retry Analysis';
            }
        }

        function renderResponse(analysis) {
            const panel = document.getElementById('response-panel');
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth' });

            // Health
            const healthEl = document.getElementById('health-status-value');
            healthEl.textContent = analysis.health_status || 'UNKNOWN';
            healthEl.className = (analysis.health_status || '').toLowerCase();

            // Severity
            const severityEl = document.getElementById('severity-badge');
            severityEl.textContent = analysis.overall_severity || 'LOW';
            severityEl.className = 'severity-badge ' + (analysis.overall_severity || 'LOW').toLowerCase();

            // Findings
            const findingsList = document.getElementById('findings-list');
            findingsList.innerHTML = (analysis.key_findings || []).map(f => `
                <div class="finding-item">
                    <div class="finding-header">
                        <span class="signal-tag">${f.signal}</span>
                        <span class="confidence-tag">${f.confidence} Confidence</span>
                    </div>
                    <div class="finding-text">${f.observation}</div>
                    <div class="finding-sub">${f.interpretation}</div>
                </div>
            `).join('');

            // Actions
            const actionsList = document.getElementById('actions-list');
            actionsList.innerHTML = (analysis.recommended_actions || []).map(a => `
                <div class="action-item">${a}</div>
            `).join('');

            // Notes
            if (analysis.notes) {
                document.getElementById('notes-section').style.display = 'block';
                document.getElementById('notes-content').textContent = analysis.notes;
            }

            // Raw
            document.getElementById('raw-response').innerHTML = syntaxHighlight(JSON.stringify(analysis, null, 2));
        }

        // Helpers
        function formatTime(iso) {
            if (!iso) return '--';
            return new Date(iso).toLocaleTimeString();
        }
        function formatTimeShort(iso) {
            if (!iso) return '-';
            const d = new Date(iso);
            return `${d.getHours()}:${d.getMinutes()}`;
        }
        function togglePrompt() {
            const el = document.querySelector('#prompt-panel .panel-body');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
        function copyResponse() {
            navigator.clipboard.writeText(JSON.stringify(geminiResponse, null, 2));
            alert('Copied!');
        }
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
                let cls = 'number';
                if (/^"/.test(match)) cls = /:$/.test(match) ? 'key' : 'string';
                return `<span class="${cls}">${match}</span>`;
            });
        }
    </script>
</body>

</html>