<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Sound Calibration & Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(90deg, #22c55e, #3b82f6, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 42px;
            font-weight: 800;
            text-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #22c55e;
            border-bottom-color: #22c55e;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .machine-btn {
            padding: 20px;
            background: #1a2332;
            border: 2px solid #333;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .machine-btn:hover {
            border-color: #22c55e;
            background: #1f2a38;
        }
        
        .machine-btn.selected {
            background: #22c55e;
            color: #000;
            border-color: #22c55e;
        }
        
        .control-panel {
            background: linear-gradient(145deg, #1a2332, #1f2937);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(34, 197, 94, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #0f1419;
            border-radius: 5px;
        }
        
        .info-label {
            font-weight: bold;
            color: #888;
        }
        
        .info-value {
            color: #22c55e;
            font-weight: bold;
            font-size: 18px;
        }
        
        button {
            padding: 10px 20px;
            background: #22c55e;
            border: none;
            color: #000;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        button:hover {
            background: #1ea850;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .stop-btn {
            background: #ef4444;
            color: white;
        }
        
        .stop-btn:hover {
            background: #dc2626;
        }
        
        canvas {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.1), inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status.info {
            background: #1e3a8a;
            color: #93c5fd;
        }
        
        .status.success {
            background: #166534;
            color: #86efac;
        }
        
        .status.error {
            background: #7f1d1d;
            color: #fca5a5;
        }
        
        .profiles-list {
            display: grid;
            gap: 15px;
        }
        
        .profile-card {
            background: #1a2332;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #22c55e;
        }
        
        .profile-header {
            font-size: 18px;
            font-weight: bold;
            color: #22c55e;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .profile-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 5px;
        }
        
        .detection-status {
            font-size: 24px;
            font-weight: bold;
            padding: 20px;
            text-align: center;
            background: #1a2332;
            border-radius: 8px;
            margin-bottom: 20px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .detection-status.active {
            background: #166534;
            color: #86efac;
        }
        
        .timer {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            color: #22c55e;
            margin: 20px 0;
        }
        
        h3 {
            margin-top: 20px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        
        /* ========== NEW UI STYLES ========== */
        
        /* Mode indicator badge */
        .mode-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
        }
        .mode-badge.listening {
            background: #22c55e;
            color: #000;
            animation: pulse 1.5s infinite;
        }
        .mode-badge.idle {
            background: #374151;
            color: #9ca3af;
        }
        .mode-badge.detecting {
            background: #3b82f6;
            color: #fff;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Listen button per machine */
        .listen-btn {
            padding: 15px 20px;
            background: #1a2332;
            border: 2px solid #333;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .listen-btn:hover:not(:disabled) {
            border-color: #22c55e;
            background: #1f2a38;
        }
        .listen-btn.listening {
            background: #166534;
            border-color: #22c55e;
            color: #86efac;
        }
        .listen-btn.has-profile {
            border-left: 4px solid #22c55e;
        }
        .listen-btn .machine-name {
            font-size: 16px;
        }
        .listen-btn .profile-status {
            font-size: 11px;
            color: #888;
        }
        .listen-btn.has-profile .profile-status {
            color: #22c55e;
        }
        
        /* Live dashboard grid */
        .live-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        @media (max-width: 900px) {
            .live-dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        /* Sensor panel card */
        .sensor-panel {
            background: #1a2332;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #333;
        }
        .sensor-panel.active {
            border-left-color: #22c55e;
        }
        .sensor-panel h4 {
            margin: 0 0 15px 0;
            color: #888;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sensor-panel .value-large {
            font-size: 36px;
            font-weight: bold;
            color: #22c55e;
            margin-bottom: 10px;
        }
        
        /* Gas status indicator */
        .gas-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #0f1419;
        }
        .gas-indicator .gas-value {
            font-size: 24px;
            font-weight: bold;
        }
        .gas-indicator .gas-label {
            font-size: 12px;
            color: #888;
        }
        .gas-indicator.safe {
            border: 2px solid #22c55e;
        }
        .gas-indicator.safe .gas-value { color: #22c55e; }
        .gas-indicator.warning {
            border: 2px solid #eab308;
        }
        .gas-indicator.warning .gas-value { color: #eab308; }
        .gas-indicator.hazardous {
            border: 2px solid #ef4444;
            background: #1f0a0a;
        }
        .gas-indicator.hazardous .gas-value { color: #ef4444; }
        
        /* Vibration bar */
        .vibration-bar-container {
            background: #0f1419;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .vibration-bar {
            height: 20px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .vibration-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
            transition: width 0.2s;
            border-radius: 4px;
        }
        .vibration-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #888;
        }
        .vibration-intensity {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        .vibration-intensity.low { background: #166534; color: #86efac; }
        .vibration-intensity.medium { background: #854d0e; color: #fde047; }
        .vibration-intensity.high { background: #7f1d1d; color: #fca5a5; }
        
        /* Machine detection result card */
        .detected-machine-card {
            background: #0f1419;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #333;
        }
        .detected-machine-card.detected {
            border-color: #22c55e;
            background: #0a1f0a;
        }
        .detected-machine-card .machine-name {
            font-size: 28px;
            font-weight: bold;
            color: #22c55e;
        }
        .detected-machine-card .confidence {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }
        .detected-machine-card.no-detection .machine-name {
            color: #666;
            font-size: 18px;
        }
        
        /* Run check results */
        .check-results {
            background: #1a2332;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .check-results h4 {
            margin: 0 0 15px 0;
            color: #e0e0e0;
        }
        .check-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #0f1419;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        .check-result-item .match {
            color: #22c55e;
            font-weight: bold;
        }
        .check-result-item .no-match {
            color: #666;
        }
        
        /* Calibration data collection indicator */
        .data-collection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .data-item {
            background: #0f1419;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .data-item .label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }
        .data-item .count {
            font-size: 18px;
            font-weight: bold;
            color: #22c55e;
        }
        .data-item.inactive .count {
            color: #666;
        }
        
        /* Audio waveform panel */
        .waveform-panel {
            grid-column: 1 / -1;
        }
        .waveform-panel canvas {
            height: 150px;
        }
        
        /* Inactive/disabled panel state */
        .panel-inactive {
            opacity: 0.5;
            pointer-events: none;
        }
        .panel-inactive::after {
            content: 'Click "Start Machine Detecting" to activate';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 12px;
            text-align: center;
        }
        
        /* Gas limit markers */
        .gas-limits {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            padding: 0 5px;
        }
        .gas-limits span {
            padding: 2px 6px;
            border-radius: 3px;
        }
        .gas-limits .safe-limit { background: #052e16; color: #22c55e; }
        .gas-limits .hazard-limit { background: #450a0a; color: #ef4444; }
        
        /* ========== CHART STYLES ========== */
        .chart-container {
            background: #0f1419;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
        }
        .chart-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .mini-chart {
            height: 80px;
            position: relative;
        }
        .spectrum-chart {
            height: 150px;
            position: relative;
        }
        .history-chart {
            height: 120px;
            position: relative;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1a2332, #1f2937);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            transition: all 0.3s;
        }
        .stat-card:hover {
            border-color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
            transform: translateY(-2px);
        }
        .stat-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: #22c55e;
        }
        .stat-unit {
            font-size: 12px;
            color: #666;
            margin-left: 4px;
        }
        
        /* Progress bars */
        .progress-bar {
            height: 8px;
            background: #1a2332;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            transition: width 0.3s;
            border-radius: 4px;
        }
        
        /* Frequency bands visualization */
        .freq-bands {
            display: flex;
            gap: 4px;
            margin-top: 10px;
            height: 60px;
            align-items: flex-end;
        }
        .freq-band {
            flex: 1;
            background: linear-gradient(180deg, #22c55e, #166534);
            border-radius: 3px 3px 0 0;
            transition: all 0.3s;
            position: relative;
        }
        .freq-band:hover {
            background: linear-gradient(180deg, #3b82f6, #1e40af);
            transform: scaleY(1.1);
        }
        .freq-band-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: #666;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Machine Sound Calibration & Detection</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'calibration')">üìä Calibration</button>
            <button class="tab-btn" onclick="switchTab(event, 'runcheck')">üîé Run Check</button>
            <button class="tab-btn" onclick="switchTab(event, 'livedetection')">üîç Live Detection</button>
            <button class="tab-btn" onclick="switchTab(event, 'profiles')">‚öôÔ∏è Profiles</button>
        </div>
        
        <!-- ===== CALIBRATION TAB (Per-Machine Listening) ===== -->
        <div id="calibration" class="tab-content active">
            <div class="status info" id="calibration-status">Click "Start Listening" on a machine to begin calibration</div>
            
            <h3>Start Listening ‚Äì Per Machine <span class="mode-badge idle" id="cal-mode-badge">IDLE</span></h3>
            <p style="color: #888; margin-bottom: 15px; font-size: 13px;">
                Each machine profile captures: Audio signature + Vibration pattern + Gas/air quality data
            </p>
            
            <!-- Machine Listen Buttons -->
            <div class="machines-grid" id="calibration-machines">
                <!-- Generated by JS -->
            </div>
            
            <!-- Calibration Control Panel -->
            <div class="control-panel" id="calibration-control-panel" style="display:none;">
                <h4 style="color: #22c55e; margin-bottom: 15px;">
                    üé§ Listening for: <span id="cal-active-machine">--</span>
                </h4>
                
                <div class="info-row">
                    <span class="info-label">Recording Duration:</span>
                    <span class="info-value" id="cal-duration">0s / 60s</span>
                </div>
                
                <!-- Data Collection Indicators -->
                <div class="data-collection">
                    <div class="data-item" id="cal-audio-data">
                        <div class="label">üéµ Audio Frames</div>
                        <div class="count" id="cal-frames">0</div>
                    </div>
                    <div class="data-item" id="cal-vibration-data">
                        <div class="label">üì≥ Vibration Samples</div>
                        <div class="count" id="cal-vib-count">0</div>
                    </div>
                    <div class="data-item" id="cal-gas-data">
                        <div class="label">üí® Gas Samples</div>
                        <div class="count" id="cal-gas-count">0</div>
                    </div>
                </div>
                
                <div class="timer" id="calibration-timer">0s</div>
                
                <div style="margin-top: 15px;">
                    <button id="calibration-stop" class="stop-btn" onclick="stopCalibration()">‚èπÔ∏è Stop Listening</button>
                    <button id="calibration-save" onclick="saveProfile()" disabled style="background: #3b82f6;">üíæ Save Profile</button>
                </div>
            </div>
            
            <!-- Waveform (only shown when listening) -->
            <div id="calibration-waveform-container" style="display:none;">
                <h3>Live Audio Waveform:</h3>
                <canvas id="calibration-canvas"></canvas>
            </div>
        </div>
        
        <!-- ===== RUN CHECK TAB ===== -->
        <div id="runcheck" class="tab-content">
            <div class="status info" id="runcheck-status">Click "Run Check" to compare current audio against stored profiles</div>
            
            <h3>Run Check for Machine</h3>
            <p style="color: #888; margin-bottom: 20px; font-size: 13px;">
                Performs a one-time check to identify which machine (if any) matches the current sound.
                No live graphs ‚Äì logical check only.
            </p>
            
            <div class="control-panel">
                <button id="runcheck-btn" onclick="runCheck()" style="font-size: 16px; padding: 15px 30px;">
                    üîé Run Check for Machine
                </button>
                <button id="runcheck-stop" class="stop-btn" onclick="stopRunCheck()" disabled style="margin-left: 10px;">
                    ‚èπÔ∏è Stop
                </button>
                
                <div id="runcheck-progress" style="display: none; margin-top: 15px;">
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="runcheck-progress-text">Analyzing...</span>
                    </div>
                </div>
            </div>
            
            <!-- Check Results (shown after check completes) -->
            <div class="check-results" id="runcheck-results" style="display: none;">
                <h4>üîç Check Results</h4>
                <div id="runcheck-results-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
        
        <!-- ===== LIVE DETECTION TAB (Main Dashboard) ===== -->
        <div id="livedetection" class="tab-content">
            <div class="status info" id="livedetection-status">Click "Start Machine Detecting" to begin live monitoring</div>
            
            <h3>Live Detection Dashboard <span class="mode-badge idle" id="live-mode-badge">IDLE</span></h3>
            
            <div style="margin-bottom: 20px;">
                <button id="live-start-btn" onclick="startLiveDetection()" style="font-size: 16px; padding: 15px 30px;">
                    üé§ Start Machine Detecting
                </button>
                <button id="live-stop-btn" class="stop-btn" onclick="stopLiveDetection()" disabled>
                    ‚èπÔ∏è Stop Detection
                </button>
            </div>
            
            <!-- Live Dashboard Grid (inactive until started) -->
            <div class="live-dashboard" id="live-dashboard">
                
                <!-- A. Machine Detection -->
                <div class="sensor-panel" id="panel-machine">
                    <h4>üîß Machine Detection</h4>
                    <div class="detected-machine-card no-detection" id="live-machine-card">
                        <div class="machine-name" id="live-detected-machine">--</div>
                        <div class="confidence" id="live-detection-confidence">Waiting...</div>
                    </div>
                    <div class="info-row" style="margin-top: 15px;">
                        <span class="info-label">Stable Machines:</span>
                        <span class="info-value" id="live-stable-machines">--</span>
                    </div>
                </div>
                
                <!-- B. Gas / Air Quality -->
                <div class="sensor-panel" id="panel-gas">
                    <h4>üí® Gas / Air Quality</h4>
                    <div class="gas-indicator safe" id="live-gas-indicator">
                        <div>
                            <div class="gas-value" id="live-gas-value">--</div>
                            <div class="gas-label">Raw Value</div>
                        </div>
                        <div style="flex: 1; text-align: right;">
                            <div style="font-size: 20px; font-weight: bold;" id="live-gas-status-text">--</div>
                            <div class="gas-label">Status</div>
                        </div>
                    </div>
                    <div class="gas-limits">
                        <span class="safe-limit">Safe: &lt; 300</span>
                        <span class="hazard-limit">Hazardous: &gt; 700</span>
                    </div>
                </div>
                
                <!-- C. Vibration Monitoring -->
                <div class="sensor-panel" id="panel-vibration">
                    <h4>üì≥ Vibration Monitoring</h4>
                    <div class="value-large" id="live-vibration-value">--</div>
                    <div class="vibration-bar-container">
                        <div class="vibration-bar">
                            <div class="fill" id="live-vibration-bar" style="width: 0%;"></div>
                        </div>
                        <div class="vibration-label">
                            <span>0</span>
                            <span class="vibration-intensity low" id="live-vibration-intensity">--</span>
                            <span>100</span>
                        </div>
                    </div>
                    <div class="info-row" style="margin-top: 10px;">
                        <span class="info-label">Event Count:</span>
                        <span class="info-value" id="live-event-count">0</span>
                    </div>
                </div>
                
                <!-- D. Audio Info -->
                <div class="sensor-panel" id="panel-audio-info">
                    <h4>üéµ Audio Analysis</h4>
                    <div class="info-row">
                        <span class="info-label">Dominant Frequency:</span>
                        <span class="info-value" id="live-freq">-- Hz</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Amplitude:</span>
                        <span class="info-value" id="live-amp">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Confidence:</span>
                        <span class="info-value" id="live-conf">--</span>
                    </div>
                </div>
                
                <!-- E. Live Waveform (spans full width) -->
                <div class="sensor-panel waveform-panel" id="panel-waveform">
                    <h4>üìä Live Audio Waveform</h4>
                    <canvas id="live-canvas"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ===== PROFILES TAB ===== -->
        <div id="profiles" class="tab-content">
            <button onclick="loadProfiles()" style="margin-bottom: 20px;">üîÑ Refresh Profiles</button>
            <div id="profiles-list" class="profiles-list">
                <p style="color: #888;">Loading profiles...</p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const BACKEND_URL = `${window.location.origin}`;
        const CALIBRATION_DURATION = 60;
        const AMPLITUDE_THRESHOLD = 0.5;
        const CONFIDENCE_THRESHOLD = 0.08;
        
        // Gas thresholds for display
        const GAS_SAFE_LIMIT = 300;
        const GAS_HAZARD_LIMIT = 700;
        
        // ==========================================
        // STATE VARIABLES
        // ==========================================
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        
        // Calibration state
        let isCalibrating = false;
        let calibrationData = [];
        let calibrationTimer = 0;
        let calibrationFrameCount = 0;
        let selectedMachine = null;
        let calibrationVibrationSamples = [];
        let calibrationGasSamples = [];
        let calibrationESP32PollTimer = null;
        
        // Run Check state
        let isRunningCheck = false;
        let runCheckBatch = [];
        let runCheckTimer = null;
        
        // Live Detection state
        let isLiveDetecting = false;
        let liveBatch = [];
        let liveBatchTimer = 0;
        let liveESP32PollTimer = null;
        
        // Canvas contexts
        let calibrationCanvasCtx = null;
        let liveCanvasCtx = null;
        
        // Stored profiles cache
        let machineProfiles = {};

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.addEventListener('load', function() {
            initializeCanvases();
            generateCalibrationButtons();
            loadProfiles();
            console.log("‚úÖ System initialized");
        });

        function initializeCanvases() {
            const calibCanvas = document.getElementById('calibration-canvas');
            const liveCanvas = document.getElementById('live-canvas');
            
            if (calibCanvas) {
                calibrationCanvasCtx = calibCanvas.getContext('2d');
                calibCanvas.width = calibCanvas.offsetWidth || 800;
                calibCanvas.height = calibCanvas.offsetHeight || 150;
            }
            if (liveCanvas) {
                liveCanvasCtx = liveCanvas.getContext('2d');
                liveCanvas.width = liveCanvas.offsetWidth || 800;
                liveCanvas.height = liveCanvas.offsetHeight || 150;
            }
        }

        function generateCalibrationButtons() {
            const container = document.getElementById('calibration-machines');
            const machines = ['machine_1', 'machine_2', 'machine_3'];
            
            container.innerHTML = machines.map(m => `
                <button class="listen-btn" id="listen-${m}" onclick="startListeningForMachine('${m}')" data-machine="${m}">
                    <span class="machine-name">${m.replace('_', ' ').toUpperCase()}</span>
                    <span class="profile-status" id="status-${m}">No profile</span>
                </button>
            `).join('');
        }

        // ==========================================
        // AUDIO INITIALIZATION
        // ==========================================
        async function initAudio() {
            try {
                // Check if already initialized and running
                if (audioContext && audioContext.state === 'running') {
                    console.log("‚úÖ Audio already initialized");
                    return true;
                }
                
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    updateStatus('calibration', '‚ùå Your browser does not support microphone access. Try Chrome or Firefox.', 'error');
                    return false;
                }
                
                console.log("üé§ Requesting microphone permission...");
                updateStatus('calibration', 'üé§ Requesting microphone permission...', 'info');
                
                // Request microphone FIRST before creating AudioContext
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { 
                        echoCancellation: false, 
                        noiseSuppression: false, 
                        autoGainControl: false 
                    }
                });
                
                console.log("‚úÖ Microphone permission granted");
                
                // Create AudioContext after getting permission
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Resume AudioContext if suspended (required by some browsers)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                analyser.minDecibels = -90;
                
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                console.log("‚úÖ Audio fully initialized");
                return true;
            } catch (error) {
                console.error("‚ùå Audio init failed:", error);
                
                // Provide specific error messages
                let errorMsg = 'Microphone error: ';
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg = '‚ùå Microphone permission denied. Click the üîí icon in address bar ‚Üí Allow microphone.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '‚ùå No microphone found. Please connect a microphone.';
                } else if (error.name === 'NotReadableError') {
                    errorMsg = '‚ùå Microphone is in use by another app. Close other apps using the mic.';
                } else if (error.name === 'SecurityError') {
                    errorMsg = '‚ùå Microphone blocked. Page must be served over HTTPS or localhost.';
                } else {
                    errorMsg += error.message;
                }
                
                updateStatus('calibration', errorMsg, 'error');
                return false;
            }
        }

        // ==========================================
        // CALIBRATION MODE (PER MACHINE)
        // ==========================================
        async function startListeningForMachine(machineId) {
            if (isCalibrating) {
                updateStatus('calibration', '‚ö†Ô∏è Already listening! Stop first.', 'error');
                return;
            }
            
            const ok = await initAudio();
            if (!ok) return;
            
            selectedMachine = machineId;
            isCalibrating = true;
            calibrationData = [];
            calibrationFrameCount = 0;
            calibrationTimer = 0;
            calibrationVibrationSamples = [];
            calibrationGasSamples = [];
            
            // Update UI
            document.getElementById('cal-mode-badge').textContent = 'LISTENING';
            document.getElementById('cal-mode-badge').className = 'mode-badge listening';
            document.getElementById('cal-active-machine').textContent = machineId.replace('_', ' ').toUpperCase();
            document.getElementById('calibration-control-panel').style.display = 'block';
            document.getElementById('calibration-waveform-container').style.display = 'block';
            document.getElementById('calibration-save').disabled = true;
            
            // Highlight active button
            document.querySelectorAll('.listen-btn').forEach(btn => {
                btn.classList.remove('listening');
                btn.disabled = true;
            });
            document.getElementById('listen-' + machineId).classList.add('listening');
            
            updateStatus('calibration', `üé§ Listening for ${machineId.replace('_', ' ').toUpperCase()}... Make steady sounds!`);
            
            // Start ESP32 polling during calibration
            startCalibrationESP32Polling();
            
            calibrationLoop();
        }

        function calibrationLoop() {
            if (!isCalibrating) return;
            
            const timeDomainData = new Uint8Array(analyser.frequencyBinCount);
            const frequencyData = new Uint8Array(analyser.frequencyBinCount);
            
            analyser.getByteTimeDomainData(timeDomainData);
            analyser.getByteFrequencyData(frequencyData);
            
            let sum = 0;
            for (let i = 0; i < timeDomainData.length; i++) {
                const val = (timeDomainData[i] - 128) / 128;
                sum += val * val;
            }
            const amplitude = Math.sqrt(sum / timeDomainData.length) * 100;
            
            let maxVal = 0, maxIndex = 0;
            for (let i = 1; i < frequencyData.length; i++) {
                if (frequencyData[i] > maxVal) {
                    maxVal = frequencyData[i];
                    maxIndex = i;
                }
            }
            
            const nyquist = audioContext.sampleRate / 2;
            const dominantFreq = (maxIndex / frequencyData.length) * nyquist;
            const freqConfidence = maxVal / 255;
            
            const peaks = extractTopPeaks(frequencyData, nyquist, 5);
            
            calibrationFrameCount++;
            
            calibrationData.push({
                amplitude,
                peaks: peaks,
                timestamp: Date.now()
            });
            
            // Update UI
            document.getElementById('cal-duration').textContent = `${Math.floor(calibrationTimer)}s / ${CALIBRATION_DURATION}s`;
            document.getElementById('cal-frames').textContent = calibrationFrameCount;
            document.getElementById('cal-vib-count').textContent = calibrationVibrationSamples.length;
            document.getElementById('cal-gas-count').textContent = calibrationGasSamples.length;
            document.getElementById('calibration-timer').textContent = `${Math.floor(calibrationTimer)}s`;
            
            drawWaveform(timeDomainData, calibrationCanvasCtx);
            
            calibrationTimer += 0.1;
            
            if (calibrationTimer >= CALIBRATION_DURATION) {
                stopCalibration();
            } else {
                setTimeout(calibrationLoop, 100);
            }
        }

        function startCalibrationESP32Polling() {
            if (calibrationESP32PollTimer) return;
            
            calibrationESP32PollTimer = setInterval(async () => {
                try {
                    const res = await fetch(BACKEND_URL + '/latest_esp32');
                    const data = await res.json();
                    console.log('ESP32 poll received:', data);
                    
                    if (data.vibration !== undefined) {
                        calibrationVibrationSamples.push(data.vibration);
                        document.getElementById('cal-vib-count').textContent = calibrationVibrationSamples.length;
                        console.log('Vibration samples now:', calibrationVibrationSamples.length);
                    }
                    if (data.gas_raw !== undefined) {
                        calibrationGasSamples.push({ raw: data.gas_raw, status: data.gas_status });
                        document.getElementById('cal-gas-count').textContent = calibrationGasSamples.length;
                        console.log('Gas samples now:', calibrationGasSamples.length);
                    }
                } catch (e) {
                    console.warn('ESP32 poll error:', e);
                }
            }, 500);
        }

        function stopCalibrationESP32Polling() {
            if (calibrationESP32PollTimer) {
                clearInterval(calibrationESP32PollTimer);
                calibrationESP32PollTimer = null;
            }
        }

        async function stopCalibration() {
            isCalibrating = false;
            stopCalibrationESP32Polling();
            
            // Update UI
            document.getElementById('cal-mode-badge').textContent = 'IDLE';
            document.getElementById('cal-mode-badge').className = 'mode-badge idle';
            document.querySelectorAll('.listen-btn').forEach(btn => {
                btn.classList.remove('listening');
                btn.disabled = false;
            });
            
            if (calibrationFrameCount > 0) {
                updateStatus('calibration', `üì§ Uploading ${calibrationData.length} frames...`, 'info');
                
                try {
                    const response = await fetch(BACKEND_URL + '/ingest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            frames: calibrationData,
                            machine_id: selectedMachine,
                            mode: 'calibration',
                            store_all: true,
                            frames_captured: calibrationData.length
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'calibration_batch_saved') {
                        updateStatus('calibration', `‚úÖ Uploaded! ${result.frames_inserted} frames. Click Save Profile.`, 'success');
                        document.getElementById('calibration-save').disabled = false;
                    } else {
                        updateStatus('calibration', `Error: ${result.error || 'Unknown'}`, 'error');
                    }
                } catch (error) {
                    updateStatus('calibration', `Upload error: ${error.message}`, 'error');
                }
            } else {
                updateStatus('calibration', '‚ö†Ô∏è No frames captured. Try again.', 'error');
            }
        }

        async function saveProfile() {
            if (calibrationFrameCount < 10) {
                updateStatus('calibration', 'Need at least 10 frames!', 'error');
                return;
            }
            
            // Debug logging
            console.log('saveProfile called');
            console.log('calibrationVibrationSamples:', calibrationVibrationSamples);
            console.log('calibrationGasSamples:', calibrationGasSamples);
            
            try {
                const payload = { 
                    machine_id: selectedMachine,
                    vibration_samples: calibrationVibrationSamples,
                    gas_samples: calibrationGasSamples
                };
                console.log('Sending payload:', JSON.stringify(payload));
                
                const response = await fetch(BACKEND_URL + '/save_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.status === 'profile_saved') {
                    updateStatus('calibration', `‚úÖ Profile saved! Median: ${result.median_freq} Hz, ${result.bands_count} bands`, 'success');
                    document.getElementById('calibration-save').disabled = true;
                    loadProfiles();
                    
                    // Update button status
                    const statusEl = document.getElementById('status-' + selectedMachine);
                    if (statusEl) {
                        statusEl.textContent = '‚úì Profile saved';
                    }
                    document.getElementById('listen-' + selectedMachine).classList.add('has-profile');
                } else {
                    updateStatus('calibration', `Error: ${result.error}`, 'error');
                }
            } catch (error) {
                updateStatus('calibration', `Error: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // RUN CHECK MODE (One-time check)
        // ==========================================
        async function runCheck() {
            const ok = await initAudio();
            if (!ok) return;
            
            isRunningCheck = true;
            runCheckBatch = [];
            
            document.getElementById('runcheck-btn').disabled = true;
            document.getElementById('runcheck-stop').disabled = false;
            document.getElementById('runcheck-progress').style.display = 'block';
            document.getElementById('runcheck-results').style.display = 'none';
            
            updateStatus('runcheck', 'üîé Analyzing audio for 3 seconds...', 'info');
            document.getElementById('runcheck-progress-text').textContent = 'Collecting samples...';
            
            // Collect for 3 seconds
            let checkDuration = 0;
            const checkLoop = () => {
                if (!isRunningCheck || checkDuration >= 3) {
                    finishRunCheck();
                    return;
                }
                
                const frequencyData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(frequencyData);
                
                const nyquist = audioContext.sampleRate / 2;
                const peaks = extractTopPeaks(frequencyData, nyquist, 5);
                
                if (peaks.length > 0) {
                    runCheckBatch.push({ peaks, timestamp: Date.now() });
                }
                
                checkDuration += 0.1;
                document.getElementById('runcheck-progress-text').textContent = `Collecting... ${checkDuration.toFixed(1)}s`;
                setTimeout(checkLoop, 100);
            };
            
            checkLoop();
        }

        function stopRunCheck() {
            isRunningCheck = false;
        }

        async function finishRunCheck() {
            isRunningCheck = false;
            document.getElementById('runcheck-btn').disabled = false;
            document.getElementById('runcheck-stop').disabled = true;
            
            if (runCheckBatch.length === 0) {
                updateStatus('runcheck', '‚ö†Ô∏è No audio detected. Make some sound!', 'error');
                document.getElementById('runcheck-progress').style.display = 'none';
                return;
            }
            
            document.getElementById('runcheck-progress-text').textContent = 'Analyzing against profiles...';
            
            try {
                // Send batch to backend for detection
                const response = await fetch(BACKEND_URL + '/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frames: runCheckBatch.map(b => ({
                            amplitude: 1,
                            peaks: b.peaks,
                            timestamp: b.timestamp
                        })),
                        mode: 'live'
                    })
                });
                
                const result = await response.json();
                
                // Display results
                document.getElementById('runcheck-progress').style.display = 'none';
                document.getElementById('runcheck-results').style.display = 'block';
                
                const detectedRaw = result.running_machines_raw || [];
                const detectedStable = result.running_machines || [];
                const allMachines = result.all_machines || [];
                
                let html = '';
                if (allMachines.length === 0) {
                    html = '<p style="color: #888;">No machine profiles found. Calibrate first!</p>';
                } else {
                    allMachines.forEach(m => {
                        const isMatch = detectedRaw.includes(m);
                        html += `
                            <div class="check-result-item">
                                <span>${m.replace('_', ' ').toUpperCase()}</span>
                                <span class="${isMatch ? 'match' : 'no-match'}">
                                    ${isMatch ? '‚úì MATCH' : '‚úó No match'}
                                </span>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('runcheck-results-list').innerHTML = html;
                
                if (detectedRaw.length > 0) {
                    updateStatus('runcheck', `‚úÖ Detected: ${detectedRaw.join(', ')}`, 'success');
                } else {
                    updateStatus('runcheck', 'No machines matched current audio.', 'info');
                }
                
            } catch (error) {
                updateStatus('runcheck', `Error: ${error.message}`, 'error');
                document.getElementById('runcheck-progress').style.display = 'none';
            }
        }

        // ==========================================
        // PROFILES
        // ==========================================
        async function loadProfiles() {
            try {
                const response = await fetch(BACKEND_URL + '/profiles');
                const profiles = await response.json();
                
                // Update cache
                machineProfiles = {};
                profiles.forEach(p => { machineProfiles[p.machine_id] = p; });
                
                // Update calibration button statuses
                ['machine_1', 'machine_2', 'machine_3'].forEach(m => {
                    const btn = document.getElementById('listen-' + m);
                    const status = document.getElementById('status-' + m);
                    if (btn && status) {
                        if (machineProfiles[m]) {
                            status.textContent = '‚úì Profile saved';
                            btn.classList.add('has-profile');
                        } else {
                            status.textContent = 'No profile';
                            btn.classList.remove('has-profile');
                        }
                    }
                });
                
                // Update profiles list
                const container = document.getElementById('profiles-list');
                
                if (profiles.length === 0) {
                    container.innerHTML = '<p style="color: #888;">No profiles trained yet.</p>';
                    return;
                }
                
                container.innerHTML = profiles.map(p => `
                    <div class="profile-card">
                        <div class="profile-header">
                            <span>${p.machine_id.replace('_', ' ').toUpperCase()}</span>
                            <button class="delete-btn" onclick="deleteProfile('${p.machine_id}')">üóëÔ∏è Delete</button>
                        </div>
                        
                        <!-- Audio Section -->
                        <div style="margin-top: 10px; padding: 10px; background: #0f1419; border-radius: 5px; border-left: 3px solid #3b82f6;">
                            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 8px; font-size: 13px;">üîä Audio Signature</div>
                            <div class="profile-detail">
                                <span>Median Frequency:</span>
                                <strong>${p.median_freq} Hz</strong>
                            </div>
                            <div class="profile-detail">
                                <span>Overall IQR Range:</span>
                                <strong>${p.iqr_low} ‚Äì ${p.iqr_high} Hz</strong>
                            </div>
                            <div class="profile-detail">
                                <span>Frequency Bands:</span>
                                <strong>${p.bands_count || 0} bands</strong>
                            </div>
                            ${p.freq_bands && p.freq_bands.length > 0 ? `
                                <div style="margin-top: 8px; padding: 8px; background: #1a2332; border-radius: 4px;">
                                    <div style="color: #888; margin-bottom: 5px; font-size: 11px;">Detected Harmonic Bands:</div>
                                    ${p.freq_bands.map((b, i) => `
                                        <div style="font-size: 12px; color: #22c55e; padding: 2px 0;">
                                            Band ${i+1}: ${b.low.toFixed(0)} ‚Äì ${b.high.toFixed(0)} Hz (${b.samples} samples)
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Vibration Section -->
                        <div style="margin-top: 10px; padding: 10px; background: #0f1419; border-radius: 5px; border-left: 3px solid #f59e0b;">
                            <div style="color: #f59e0b; font-weight: bold; margin-bottom: 8px; font-size: 13px;">üì≥ Vibration Pattern</div>
                            ${p.vibration_data ? `
                                <div class="profile-detail">
                                    <span>Samples Collected:</span>
                                    <strong>${p.vibration_data.samples}</strong>
                                </div>
                                <div class="profile-detail">
                                    <span>Vibration Detected:</span>
                                    <strong style="color: ${p.vibration_data.has_vibration ? '#22c55e' : '#888'};">
                                        ${p.vibration_data.vibration_percent}% of samples
                                    </strong>
                                </div>
                                <div class="profile-detail">
                                    <span>Status:</span>
                                    <strong style="color: ${p.vibration_data.has_vibration ? '#22c55e' : '#888'};">
                                        ${p.vibration_data.has_vibration ? '‚úì Machine Vibrates' : '‚úó No Vibration'}
                                    </strong>
                                </div>
                            ` : `
                                <div style="color: #666; font-size: 12px;">No vibration data collected</div>
                            `}
                        </div>
                        
                        <!-- Gas/Air Quality Section -->
                        <div style="margin-top: 10px; padding: 10px; background: #0f1419; border-radius: 5px; border-left: 3px solid ${
                            p.gas_data ? (p.gas_data.status === 'SAFE' ? '#22c55e' : p.gas_data.status === 'MODERATE' ? '#f59e0b' : p.gas_data.status === 'NO_DATA' ? '#666' : '#ef4444') : '#666'
                        };">
                            <div style="color: ${
                                p.gas_data ? (p.gas_data.status === 'SAFE' ? '#22c55e' : p.gas_data.status === 'MODERATE' ? '#f59e0b' : p.gas_data.status === 'NO_DATA' ? '#666' : '#ef4444') : '#666'
                            }; font-weight: bold; margin-bottom: 8px; font-size: 13px;">üí® Air Quality</div>
                            ${p.gas_data ? `
                                <div class="profile-detail">
                                    <span>Samples Collected:</span>
                                    <strong>${p.gas_data.valid_samples || p.gas_data.samples} / ${p.gas_data.samples}</strong>
                                </div>
                                <div class="profile-detail">
                                    <span>Average Gas Level:</span>
                                    <strong>${p.gas_data.avg_raw}</strong>
                                </div>
                                <div class="profile-detail">
                                    <span>Range:</span>
                                    <strong>${p.gas_data.min_raw} ‚Äì ${p.gas_data.max_raw}</strong>
                                </div>
                                <div class="profile-detail">
                                    <span>Status:</span>
                                    <strong style="color: ${p.gas_data.status === 'SAFE' ? '#22c55e' : p.gas_data.status === 'MODERATE' ? '#f59e0b' : p.gas_data.status === 'NO_DATA' ? '#666' : '#ef4444'};">
                                        ${p.gas_data.status === 'SAFE' ? '‚úì Safe (<800)' : p.gas_data.status === 'MODERATE' ? '‚ö†Ô∏è Moderate (800-2000)' : p.gas_data.status === 'NO_DATA' ? '‚ùì No valid readings' : 'üö® Hazardous (>2000)'}
                                    </strong>
                                </div>
                            ` : `
                                <div style="color: #666; font-size: 12px;">No gas data collected</div>
                            `}
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 11px; color: #666;">
                            Created: ${p.created_at || 'Unknown'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        async function deleteProfile(machineId) {
            if (!confirm(`Delete profile for ${machineId.replace('_', ' ').toUpperCase()}?`)) {
                return;
            }
            
            try {
                const response = await fetch(BACKEND_URL + '/delete_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machine_id: machineId })
                });
                
                const result = await response.json();
                
                if (result.status === 'profile_deleted') {
                    alert(`‚úÖ Profile deleted: ${machineId}`);
                    loadProfiles();  // Refresh list
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error deleting profile: ${error.message}`);
            }
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function drawWaveform(data, ctx) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < data.length; i++) {
                const x = (i / data.length) * ctx.canvas.width;
                const y = ctx.canvas.height - ((data[i] / 255) * ctx.canvas.height);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        // ==========================================
        // PEAK EXTRACTION (NEW - CRITICAL FOR MULTI-MACHINE)
        // ==========================================
        /**
         * Extract top N peaks from frequency data.
         * Uses local maxima detection with minimum separation.
         * @param {Uint8Array} frequencyData - FFT frequency bins
         * @param {number} nyquist - Nyquist frequency (sampleRate/2)
         * @param {number} numPeaks - Number of peaks to extract (default 5)
         * @returns {Array} Array of {freq, amp} objects sorted by amplitude (descending)
         */
        function extractTopPeaks(frequencyData, nyquist, numPeaks = 5) {
            const peaks = [];
            const minSeparation = 5; // Minimum bin separation between peaks
            const minAmplitude = 10; // Minimum raw FFT value to consider (0-255) - lowered to capture quieter sounds
            
            // Find all local maxima
            for (let i = 2; i < frequencyData.length - 2; i++) {
                const val = frequencyData[i];
                
                // Skip if below minimum amplitude
                if (val < minAmplitude) continue;
                
                // Check if local maximum (higher than neighbors)
                if (val > frequencyData[i-1] && 
                    val > frequencyData[i+1] &&
                    val >= frequencyData[i-2] && 
                    val >= frequencyData[i+2]) {
                    
                    const freq = (i / frequencyData.length) * nyquist;
                    const amp = val / 255; // Normalize to 0-1
                    
                    peaks.push({ freq, amp, bin: i });
                }
            }
            
            // Sort by amplitude (descending)
            peaks.sort((a, b) => b.amp - a.amp);
            
            // Select top peaks with minimum separation
            const selectedPeaks = [];
            for (const peak of peaks) {
                // Check if far enough from already selected peaks
                let tooClose = false;
                for (const selected of selectedPeaks) {
                    if (Math.abs(peak.bin - selected.bin) < minSeparation) {
                        tooClose = true;
                        break;
                    }
                }
                
                if (!tooClose) {
                    selectedPeaks.push({ freq: peak.freq, amp: peak.amp });
                    if (selectedPeaks.length >= numPeaks) break;
                }
            }
            
            return selectedPeaks;
        }

        function switchTab(event, tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            
            // Initialize canvas when switching to live detection
            if (tab === 'livedetection') {
                setTimeout(initializeCanvases, 100);
            }
        }

        function updateStatus(tab, message, type = 'info') {
            const el = document.getElementById(tab + '-status');
            if (el) {
                el.textContent = message;
                el.className = 'status ' + type;
            }
        }

        // ==========================================
        // LIVE DETECTION MODE (Main Dashboard)
        // ==========================================
        async function startLiveDetection() {
            const ok = await initAudio();
            if (!ok) {
                updateStatus('livedetection', '‚ùå Microphone access required', 'error');
                return;
            }
            
            isLiveDetecting = true;
            liveBatch = [];
            liveBatchTimer = 0;
            
            // Update UI
            document.getElementById('live-mode-badge').textContent = 'DETECTING';
            document.getElementById('live-mode-badge').className = 'mode-badge detecting';
            document.getElementById('live-start-btn').disabled = true;
            document.getElementById('live-stop-btn').disabled = false;
            
            updateStatus('livedetection', 'üé§ Live detection running...', 'success');
            
            // Start ESP32 polling for live mode
            startLiveESP32Polling();
            
            // Start audio detection loop
            liveDetectionLoop();
        }

        function liveDetectionLoop() {
            if (!isLiveDetecting) return;
            
            const timeDomainData = new Uint8Array(analyser.frequencyBinCount);
            const frequencyData = new Uint8Array(analyser.frequencyBinCount);
            
            analyser.getByteTimeDomainData(timeDomainData);
            analyser.getByteFrequencyData(frequencyData);
            
            let sum = 0;
            for (let i = 0; i < timeDomainData.length; i++) {
                const val = (timeDomainData[i] - 128) / 128;
                sum += val * val;
            }
            const amplitude = Math.sqrt(sum / timeDomainData.length) * 100;
            
            let maxVal = 0, maxIndex = 0;
            for (let i = 1; i < frequencyData.length; i++) {
                if (frequencyData[i] > maxVal) {
                    maxVal = frequencyData[i];
                    maxIndex = i;
                }
            }
            
            const nyquist = audioContext.sampleRate / 2;
            const dominantFreq = (maxIndex / frequencyData.length) * nyquist;
            const freqConfidence = maxVal / 255;
            
            const peaks = extractTopPeaks(frequencyData, nyquist, 5);
            
            // Collect frame
            liveBatch.push({
                amplitude,
                peaks: peaks,
                dominant_freq: dominantFreq,
                freq_confidence: freqConfidence,
                timestamp: Date.now()
            });
            
            // Update audio UI
            document.getElementById('live-freq').textContent = dominantFreq.toFixed(1) + ' Hz';
            document.getElementById('live-amp').textContent = amplitude.toFixed(2);
            document.getElementById('live-conf').textContent = freqConfidence.toFixed(3);
            
            // Draw waveform
            if (liveCanvasCtx) {
                drawWaveform(timeDomainData, liveCanvasCtx);
            }
            
            // Send batch every 500ms
            liveBatchTimer += 0.1;
            if (liveBatchTimer >= 0.5) {
                if (liveBatch.length > 0) {
                    sendLiveBatch();
                }
                liveBatch = [];
                liveBatchTimer = 0;
            }
            
            setTimeout(liveDetectionLoop, 100);
        }

        async function sendLiveBatch() {
            try {
                const response = await fetch(BACKEND_URL + '/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frames: liveBatch,
                        mode: 'live'
                    })
                });
                
                const data = await response.json();
                
                // Update machine detection display
                const card = document.getElementById('live-machine-card');
                const nameEl = document.getElementById('live-detected-machine');
                const confEl = document.getElementById('live-detection-confidence');
                const stableEl = document.getElementById('live-stable-machines');
                
                const detected = data.running_machines_raw || [];
                const stable = data.running_machines || [];
                
                if (stable.length > 0) {
                    nameEl.textContent = stable.map(m => m.replace('_', ' ').toUpperCase()).join(', ');
                    confEl.textContent = 'Stable detection';
                    card.className = 'detected-machine-card detected';
                } else if (detected.length > 0) {
                    nameEl.textContent = detected.map(m => m.replace('_', ' ').toUpperCase()).join(', ');
                    confEl.textContent = 'Detecting...';
                    card.className = 'detected-machine-card';
                } else {
                    nameEl.textContent = 'No machine detected';
                    confEl.textContent = 'Listening...';
                    card.className = 'detected-machine-card no-detection';
                }
                
                stableEl.textContent = stable.length > 0 ? stable.join(', ') : '--';
                
            } catch (err) {
                console.warn('Live batch error:', err);
            }
        }

        function startLiveESP32Polling() {
            if (liveESP32PollTimer) return;
            
            fetchLiveESP32Data();
            liveESP32PollTimer = setInterval(fetchLiveESP32Data, 1000);
        }

        function stopLiveESP32Polling() {
            if (liveESP32PollTimer) {
                clearInterval(liveESP32PollTimer);
                liveESP32PollTimer = null;
            }
        }

        async function fetchLiveESP32Data() {
            try {
                const res = await fetch(BACKEND_URL + '/latest_esp32');
                const data = await res.json();
                
                // Update vibration display
                const vibValue = data.vibration || 0;
                document.getElementById('live-vibration-value').textContent = vibValue > 0 ? 'ON' : 'OFF';
                
                const vibPercent = Math.min(vibValue * 100, 100);
                document.getElementById('live-vibration-bar').style.width = vibPercent + '%';
                
                const intensityEl = document.getElementById('live-vibration-intensity');
                if (vibValue > 0.7) {
                    intensityEl.textContent = 'HIGH';
                    intensityEl.className = 'vibration-intensity high';
                } else if (vibValue > 0.3) {
                    intensityEl.textContent = 'MEDIUM';
                    intensityEl.className = 'vibration-intensity medium';
                } else {
                    intensityEl.textContent = 'LOW';
                    intensityEl.className = 'vibration-intensity low';
                }
                
                document.getElementById('live-event-count').textContent = data.event_count || 0;
                
                // Update gas display
                const gasRaw = data.gas_raw || 0;
                const gasStatus = data.gas_status || 'UNKNOWN';
                
                document.getElementById('live-gas-value').textContent = gasRaw;
                document.getElementById('live-gas-status-text').textContent = gasStatus;
                
                const gasIndicator = document.getElementById('live-gas-indicator');
                gasIndicator.className = 'gas-indicator';
                
                if (gasRaw > GAS_HAZARD_LIMIT || gasStatus === 'RISK' || gasStatus === 'DANGER') {
                    gasIndicator.classList.add('hazardous');
                } else if (gasRaw > GAS_SAFE_LIMIT || gasStatus === 'WARNING') {
                    gasIndicator.classList.add('warning');
                } else {
                    gasIndicator.classList.add('safe');
                }
                
            } catch (err) {
                console.warn('ESP32 fetch error:', err);
            }
        }

        function stopLiveDetection() {
            isLiveDetecting = false;
            liveBatch = [];
            liveBatchTimer = 0;
            
            stopLiveESP32Polling();
            
            document.getElementById('live-mode-badge').textContent = 'IDLE';
            document.getElementById('live-mode-badge').className = 'mode-badge idle';
            document.getElementById('live-start-btn').disabled = false;
            document.getElementById('live-stop-btn').disabled = true;
            
            updateStatus('livedetection', 'Detection stopped.', 'info');
        }
    </script>
</body>
</html>